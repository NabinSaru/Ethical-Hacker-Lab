# NMAP

```sh
-h # help manual
-v # add verbosity
-vv ## higher verbosity
```

## NMAP Top 5

```sh
nmap -sn 192.168.1.0/24 # Ping scan
nmap --top-ports 20 192.168.1.1 # Top ports
nmap -O 192.168.1.1 # OS detection
nmap -A 192.168.1.1 # Aggressive scan: OS, Version, Trace route
nmap -p 80 192.168.1.1 # Port assignment
```

## Ping scan

Ping scan use the ARP protocol to discover the network devices. It scans for the port 80 and 443 in the Ping scan mode.

```sh
nmap -sn 192.168.1.0/24 # Quick native TCP connection mode
sudo nmap -sn 192.168.1.0/24 # Addittionally enable ICMP ping
```

NMAP by default use the TCP scan only as ICMP may not be responded by the devices. UDP scan can be performed by adding flag `-sU` and ICMP by running the scan in the root privileges.

## Stealth Scan

This relies on the incomplete handshake for the connection. The source doesn't response with ACK after getting SYN, ACK. This cause the destination to maintain any incomplete handshake log.

```nmap -sS 192.168.1.1```

However, on inspecting the packet in the transmission (traffic), the window size of packet is 1024 i.e. default by the NMAP which may be different from the maximum segment size. Hence, TCP SYN packet with window size value 1024 is likely to be generated by NMAP.

## TCP Connect Scan

This use the full TCP connection handshake as a result may be logged in the destination.

```nmap -sT 192.168.1.1```

## Null, Fin, Ack and Xmas scan

```sh
sudo nmap -sF 192.168.1.1 # Fin scan
sudo nmap -sA 192.168.1.1 # Ack scan
sudo nmap -sN 192.168.1.1 # Null scan
sudo nmap -sX 192.168.1.1 # x-mas scan
```

These scan relies on the fact that the response to the invalid package (null) or invalid handshake responses. For an example, consider the FIN scan, if FIN packet is sent without SYN or proper handshake. If RST is sent back, this mean the port is open. These may still apply to the older IOT devices enumeration but is mitigated by modern firewalls. Modern firewalls are stateful: designed to drop the packets that don't follow protocol or is invalid.

## UDP Scan

More and more applications are adopting the UDP protocol instead of the TCP. For example, DNS, chargen, ntp e.t.c. UDP scan are relatively time-consuming so port specification is important in order to filter out the unwanted traffic.

```sudo nmap -sU -p19,53,123 192.168.1.1```

Consider the following NMAP response for the scanme.nmap.org.

```sh
sudo nmap -sU -p19,53,123 scanme.nmap.org
Starting Nmap 7.95 ( https://nmap.org ) at 2025-01-10 09:03 EST
Nmap scan report for scanme.nmap.org (45.33.32.156)
Host is up (0.35s latency).

PORT    STATE         SERVICE
19/udp  closed        chargen
53/udp  open|filtered domain
123/udp open          ntp
```

Here chargen service is closed because the ICMP header specify that the destination/port is unreachable. ntp is open because it receives the valid response from the destination. Open/filtered on the other hand may be due to the fact that the application may not generate any response for the datagram as lacks the data in the data field and the application don't have any idea with how to proceed with the null data. Or, the packet is filtered by firewall. Hence, open/filtered state.

## OS and version detection

NMAP maps the responses from the handshake packets with the database records to figure out the OS version and reads the versions of the application from packet response.

```sh
sudo nmap -O 192.168.1.1 # OS detection
sudo nmap -sV 192.168.1.1 # Version detection
```

## Timing Templates

Specifies the aggressiveness of the scanning.

```sh
sudo nmap -T0 192.168.1.1 # Paranoid
sudo nmap -T1 192.168.1.1 # Sneaky
sudo nmap -T2 192.168.1.1 # Polite
sudo nmap -T3 192.168.1.1 # Normal, Default
sudo nmap -T4 192.168.1.1 # Aggressive
sudo nmap -T5 192.168.1.1 # Insane
```

## NMAP Scripting Engine (NSE)

```sh
ls usr/share/nmap/scripts # list all available scripts
nmap --script-updatedb # update the scripts
nmap --script "http-auth" scanme.nmap.org # using specific script
nmap --script "ftp-*" scanme.nmap.org # using wild card for the matching scripts
nmap --script default,safe scanme.nmap.org # Loads all scripts in the default and safe categories
nmap --script default,banner,/home/user/customscripts # Loads the script in the default category, the banner script, and all .nse files in the directory /home/user/customscripts.
```

Additionally, here are some of the supported syntax from NMAP documentation.

```sh
nmap --script "not intrusive" # Loads every script except for those in the intrusive category.
nmap --script "default or safe" #This is functionally equivalent to nmap --script "default,safe". It loads all scripts that are in the default category or the safe category or both.
nmap --script "default and safe" # Loads those scripts that are in both the default and safe categories.
nmap --script "(default or safe or intrusive) and not http-*" # Loads scripts in the default, safe, or intrusive categories, except for those whose names start with http-.
```

### NMAP Default Scripts

```sh
nmap -sC scanme.nmap.org # or
nmap --script=default scanme.nmap.org # or
nmap --script default scanme.nmap.org
```

### Banner Script

A simple banner grabber which connects to an open TCP port and prints out anything sent by the listening service within five seconds.

```sh
nmap --script "banner" scanme.nmap.org
```

### HTTP Scripts

```sh
nmap --script "http-methods" scanme.nmap.org # checks the available http request types
nmap --script "http-enum" scanme.nmap.org # enumerate the http application
```

## Frequent NSE Scripts

```sh
nmap --script "banner" 172.17.0.2 # services and version
nmap --script "http-enum" 172.17.0.2 # enumerate the http application
nmap --script "ftp-anon" 172.17.0.2 -p 21 # check if the anonymous login is supportedb in ftp port
nmap --script "ftp-brute" 172.17.0.2 -p 21 # brute force the login credentials for ftp login
nmap --script "smb-enum-users" 172.17.0.2 # enumerate the microsoft smb users for port 445
nmap -sV --script "vulners" 172.17.0.2 # maps the service version with the vulnerability database (CVE)
nmap --script "ssl-enum-ciphers" 172.17.0.2 -p 443 # Discover the TLS version and finds the supported ciphers with their security grade
```

## Firewall / IDS Evasion and IP Spoofing

### Fragmentation

Split the TCP header over several packets to make it harder for the packet filters and IDS for detection.
However, this may be detected by modern firewalls and prevented or the service may be programmed to not accept fragmented packets.

```sh
sudo nmap -sS -f scanme.nmap.org -p 80
```

### IP Spoofing

IP Spoofing is basically spoofing(faking) the source IP of the packet with another IP. This can be done with following command.

```sh
sudo nmap -sS -p80 -S 192.168.1.200 -e eth0 scanme.nmap.org # -S specifies the spoofed IP and -e network adapter name
```

This maybe one-way transmission only because the response will be sent to the spoofed IP not the actual source IP. Unless there is way to intercept the response.

### Decoy Scan (Cloaked Scan)

Nmap's decoy scan option, -D, makes it appear as if multiple hosts are scanning a target, hiding the attacker's identity.
Nmap sends multiple packets with different IP addresses, along with the attacker's IP address. This makes it difficult for the target to determine which hosts are the attackers and which are decoys.

```sh
sudo nmap -sS -p80 -D 192.168.1.200,192.168.1.201,192.168.1.202 -e eth0 scanme.nmap.org # -D specifies the decoy IPs along with real IP and -e network adapter name
sudo nmap -sS -p80 -D RND:20 -e eth0 scanme.nmap.org # Decoy using random 20 IPs
```
